#!/bin/bash
# Script de configuración inicial desde máquina local

# Variables
USERsv1="usuario"
PASSsv1="usuario"     # Contraseña del usuario de la máquina local y remota
PASSsv2="melon"       # Nueva contraseña para root
HOST_IP0="192.168.238.150"  # IP de la máquina remota (Server)
HOST_IP="192.168.239.231"   # Nueva IP estática para la máquina local

# ----------------------
# Parte local
# ----------------------

echo "[+] Actualizando repositorios y paquetes..."
echo "$PASSsv1" | sudo -S apt update
echo "$PASSsv1" | sudo -S apt upgrade -y

echo "[+] Instalando sshpass..."
echo "$PASSsv1" | sudo -S apt install sshpass -y

# ----------------------
# Parte remota (Server)
# ----------------------

echo "[+] Configurando la máquina Server remotamente..."

sshpass -p "$PASSsv1" ssh -o StrictHostKeyChecking=no "$USERsv1@$HOST_IP0" << EOF
echo "$PASSsv1" | sudo -S bash -c '
    # Cambiar contraseña de root
    echo "root:$PASSsv2" | chpasswd

    # Cambiar hostname
    hostnamectl set-hostname Server
'
EOF

# ----------------------
# Parte local: Red
# ----------------------

echo "[+] Configurando red local..."

# Backup de netplan
echo "$PASSsv1" | sudo -S cp /etc/netplan/50-cloud-init.yaml /etc/netplan/50-cloud-init.yaml.bkup

# Reescribir el archivo de netplan usando tee para evitar problemas con EOF anidados
echo "$PASSsv1" | sudo -S tee /etc/netplan/50-cloud-init.yaml > /dev/null <<EOF
network:
    ethernets:
        enp1s0:
            dhcp4: false
            addresses:
            - $HOST_IP/22
            routes:
                - to: default
                  via: 192.168.236.1
            nameservers:
                addresses: [192.168.236.1]
    version: 2
EOF

# Aplicar configuración de red
echo "[+] Aplicando configuración de red..."
echo "$PASSsv1" | sudo -S netplan apply

echo "[✔] Script finalizado correctamente."
